<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>DBA Deals</title>
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <script src="https://unpkg.com/htmx.org@1.9.12/dist/ext/sse.js"></script>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 1rem auto; max-width: 960px; padding: 0 1rem; }
      form { display: flex; gap: .5rem; flex-wrap: wrap; align-items: end; }
      label { display: flex; flex-direction: column; font-size: .9rem; }
      input[type="text"], input[type="number"] { padding: .4rem .5rem; border: 1px solid #ddd; border-radius: 6px; }
      button { padding: .5rem .8rem; border: 0; background: #0b6cff; color: white; border-radius: 6px; cursor: pointer; }
      .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: .75rem; margin-top: 1rem; }
      .card { border: 1px solid #eee; border-radius: 8px; padding: .5rem; }
      .title { font-weight: 600; margin: .3rem 0; }
      .price { color: #0b6cff; font-weight: 600; }
      img { width: 100%; height: 140px; object-fit: cover; border-radius: 6px; background: #fafafa; }
    </style>
    <script>
      // Drop empty params from HTMX requests so you only send what you fill
      document.addEventListener('htmx:configRequest', function (e) {
        try {
          if (e.detail && e.detail.verb === 'get' && (e.detail.path || '').startsWith('/search')) {
            const params = e.detail.parameters || {};
            for (const k of Object.keys(params)) {
              if (params[k] === '' || params[k] === null) {
                delete params[k];
              }
            }
          }
        } catch (_) {}
      });
      // Trim the Latest Results pane to at most 24 cards
      document.addEventListener('htmx:afterSwap', function (e) {
        try {
          const tgt = e.detail && e.detail.target;
          if (!tgt || tgt.id !== 'recent-list') return;
          const max = 24;
          while (tgt.children.length > max) {
            tgt.removeChild(tgt.lastElementChild);
          }
        } catch (_) {}
      });
    </script>
  </head>
  <body>
    <h1>DBA Deals</h1>
    <p>Start a scrape and see results quickly. You can also filter locally using a sample exported by the spider (listings.json).</p>
    <h3>Start Scrape</h3>
    <form hx-post="/scrape" hx-target="#scrape-status" hx-swap="innerHTML">
      <label>Start URLs (space or comma separated)
        <input name="start_urls" type="text" placeholder="https://example.com/page1 https://example.com/page2" required />
      </label>
      <label>
        <input type="checkbox" name="newest_first" value="1" checked />
        Order newest first (append sort=PUBLISHED_DESC)
      </label>
      <label>Pages to crawl (optional)
        <input name="pages" type="number" min="1" placeholder="e.g. 3" />
      </label>
      <label>Workers
        <input name="workers" type="number" min="1" placeholder="e.g. 4" />
      </label>
      <label>Concurrency per worker
        <input name="concurrency" type="number" min="1" placeholder="e.g. 16" />
      </label>
      <label>
        <input type="checkbox" name="fetch_images" value="1" /> Download first image per listing (slower)
      </label>
      <button type="submit">Start</button>
    </form>
    <div id="scrape-status"></div>
    <!-- Keep the jobs list fresh across refreshes -->
    <div hx-get="/scrape/jobs" hx-trigger="load, every 1s" hx-target="#scrape-status" hx-swap="innerHTML" style="display:none"></div>

    <div id="schedules-panel" hx-get="/schedules" hx-trigger="load, every 30s" hx-swap="innerHTML"></div>

    <h3>Latest Results</h3>
    <input id="recent-since" name="since" type="hidden" value="" />
    <div id="recent-list" class="grid"></div>
    <!-- Initial load fills recent list; SSE & poll prepend new items since last timestamp -->
    <div hx-get="/recent" hx-trigger="load" hx-target="#recent-list" hx-swap="innerHTML" style="display:none"></div>
    <div hx-get="/recent" hx-include="#recent-since" hx-trigger="sse:new_results from:#events, every 5s" hx-target="#recent-list" hx-swap="afterbegin" style="display:none"></div>
    <div id="events" hx-ext="sse" sse-connect="/events"></div>

    <h3>Search</h3>
    <form id="search-form" hx-get="/search" hx-target="#results" hx-swap="innerHTML" hx-trigger="submit">
      <label>Keywords (include)
        <input name="q" type="text" placeholder="e.g. batavus carbon" />
      </label>
      <label>Keywords (exclude)
        <input name="qx" type="text" placeholder="e.g. defekt reservedele" />
      </label>
      <label>Location include
        <input name="loc" type="text" placeholder="e.g. KÃ¸benhavn Aarhus" />
      </label>
      <label>Location exclude
        <input name="locx" type="text" placeholder="e.g. Bornholm" />
      </label>
      <label>Min price
        <input name="min_price" type="number" step="0.01" />
      </label>
      <label>Max price
        <input name="max_price" type="number" step="0.01" />
      </label>
      <label>Min images
        <input name="min_images" type="number" min="0" />
      </label>
      <label>Max age (days)
        <input name="max_age_days" type="number" min="0" />
      </label>
      <label>
        <input type="checkbox" name="use_llm" value="1" /> Use LLM scoring (dev stub)
      </label>
      <button type="submit">Search</button>
    </form>
    <!-- Listener that refreshes results on SSE or as periodic fallback -->
    <div hx-get="/search" hx-include="#search-form" hx-target="#results" hx-trigger="load, sse:new_results from:#events, every 3s" hx-swap="innerHTML" style="display:none"></div>

    <div id="results">
      {% include 'partials/results.html' %}
    </div>
  </body>
  </html>
